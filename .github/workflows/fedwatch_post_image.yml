on:
  workflow_dispatch:
    inputs:
      mode:
        required: true
      text:
        required: true
      dry_run:
        required: true
      fedwatch_json:
        required: true


- name: Generate FedWatch Image
  env:
    MODE: ${{ inputs.mode }}
    FEDWATCH_JSON: ${{ inputs.fedwatch_json }}
  run: |
    node << 'EOF'
    import { createCanvas } from "canvas";
    import fs from "fs";

    const data = JSON.parse(process.env.FEDWATCH_JSON);
    const mode = process.env.MODE || "pre";

    const rows = data.probabilities || [];
    const meetingDate = data.meetingDate || "FOMC";

    const width = 900;
    const rowH = 48;
    const height = 140 + rows.length * rowH;

    const canvas = createCanvas(width, height);
    const ctx = canvas.getContext("2d");

    ctx.fillStyle = "#fff";
    ctx.fillRect(0, 0, width, height);

    ctx.fillStyle = mode === "post" ? "#065f46" : "#1e3a8a";
    ctx.font = "bold 30px Sans";
    ctx.fillText(
      mode === "post" ? "FedWatch (After FOMC)" : "FedWatch (Before FOMC)",
      30,
      42
    );

    ctx.fillStyle = "#111";
    ctx.font = "20px Sans";
    ctx.fillText(`Meeting: ${meetingDate}`, 30, 72);

    let y = 110;
    ctx.font = "bold 20px Sans";
    ctx.fillText("Target Rate", 40, y);
    ctx.fillText("Probability", 360, y);

    y += 16;
    ctx.font = "20px Sans";

    const maxP = Math.max(...rows.map(r => Number(r.probability)));

    rows.forEach(r => {
      y += rowH;
      const p = Number(r.probability);

      ctx.fillStyle = p === maxP ? "#dc2626" : "#000";
      ctx.fillText(r.targetRate, 40, y);
      ctx.fillText(`${p.toFixed(1)}%`, 360, y);

      ctx.fillStyle = p === maxP ? "#dc2626" : "#2563eb";
      ctx.fillRect(480, y - 18, p * 3, 18);
    });

    fs.writeFileSync("fedwatch.png", canvas.toBuffer("image/png"));
    EOF
